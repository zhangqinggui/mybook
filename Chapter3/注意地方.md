#注意地方

## 设计

首先是确定索引字段，为什么样将这个放在第一个呢。因为ES的索引是一旦确定下来就不能做任何的修改了，只能删除重新创建索引。所以选择好索引字段是非常重要的。根据搜索字段我们创建索引的时候要注意以下几点：
 
1. 经常变动的数据且要一变动就马上显示的数据，这种数据不要放在ES中。
 
2. 不要将不需要的数据库表字段添加到ES索引中，浪费资源。
 
3. 不要将经常变动的状态字段放在ES中。
 
4. 为了同步数据方便，不要轻易将多张表的字段放在同一个索引中去。
 
5. 第五点可能会和第四点相互矛盾，就是尽可能只通过查询ES就可以将数据查询出来，而不是需要二次查询数据库，因为这样很容易照成n+1次查询的出现。
 
6. 权重字段。排序。多种情况或者多种字段的排序，需要设计成可配置，方便随时调整。


## 数据同步
为什么要：
- Es不是关系型数据库
- Es不支持事务
- Es近实时性

数据的同步方案有两种：
 
1. 工具同步：如果索引和数据库表一一对应，索引的字段没有超出数据库表的范围，就可以采用第三方框架来同步数据。这种方式的好处是对代码没有侵入性，直接同步数据库数据到索引中就可以了，缺点是不够灵活，功能被框架限制死。
 
2. 代码同步：如果索引和数据库表不是一一对应，甚至还需要进行一些处理。这种情况下我们可以采用跑定时任务的模式，进行程序同步。好处是可控性大大增加了，缺点是对代码的侵入性太大，定时任务出问题不好处理。数据同步千万不要时时刻刻同步，这样的设计会搞死ES服务，所以一般都是在凌晨或者特定的时间同步一次。
 
3. 使用ES的同学需要设计数据同步的功能，无法直接修改es数据.


## 分页

Elasticsearch的两个参数：
- size 每次返回多少个结果，默认值为10
- from 忽略最初的几条结果，默认值为0

```
GET /_search?size=10

GET /_search?size=10&from=10

GET /_search?size=10&from=20

```
为了说明白为什么页码过大的请求会产生问题，我们就先预想一下我们在搜索一个拥有5个主分片的索引。当我们请求第一页搜索的时候，每个分片产生自己前十名，然后将它们返回给请求节点，然后这个节点会将50条结果重新排序以产生最终的前十名。

现在想想一下我们想获得第1,000页，也就是第10,001到第10,010条结果，与之前同理，每一个分片都会先产生自己的前10,010名，然后请求节点统一处理这50,050条结果，然后再丢弃掉其中的50,040条！

现在你应该明白了，在分布式系统中，大页码请求所消耗的系统资源是呈指数式增长的。这也是为什么网络搜索引擎不会提供超过1,000条搜索结果的原因。

Elasticsearch怎么支持聚合后分页

1. 全量聚合，size设置为： 2147483647。 ES5.X/6.X版本设置为2147483647 ，它等于2^31-1， 是32位操作系统中最大的符号型整型常量；ES1.X 2.X版本设置为0。

2. 将聚合结果存入内存中，可以考虑list或map存储。 这里存入list的_id是基于某种规则排序过的，如：基于插入时间。

3. 内存内分页，基于list中存储值结合偏移值进行筛选。 如每页10条数据，取第一页就是：取list中第0到第9个元素，以此类推。

4. 基于筛选出的值进行二次查询获取详情。 此处的筛选条件已经能唯一确定一篇document