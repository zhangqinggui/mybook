## 更新elasticsearch

出于一些原因，可能需要更新现有的一篇文档。

文档的更新包括检索文档，处理文档，并重新索引文档，直至先前的文档被覆盖。


### 使用更新API

1. 发送部分文档。更新一个或者多个字段的操作。

2. 使用upsert来创建尚且不存在的文档。没有这个文档就插入

3. 通过脚本更新文档。Groovy语言。


### 更新elasticsearch面临并发

Elasticsearch 支持并发控制，为每一篇文档设置了版本号，通过版本号来实现并发。

乐观锁的方式控制并发，允许并行的操作，它认为并操作的冲突很少出现，真的出现就抛出异常。

Elasticsearch是分布式的。当文档被创建、更新或删除，文档的新版本会被复制到集群的其它节点。Elasticsearch即是同步的又是异步的，意思是这些复制请求都是平行发送的，并无序(out of sequence)的到达目的地。这就需要一种方法确保老版本的文档永远不会覆盖新的版本。

```
GET /driver_fat/_doc/33

{
   。。。
   "_version": 4,
   。。。
}
```


建议：

所有更新和删除文档的请求都接受version参数，它可以允许在你的代码中增加乐观锁控制。




